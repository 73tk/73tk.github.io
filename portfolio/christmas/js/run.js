$(function() {
    'use strict';

    /***

    ■ Animation js

    dependencies: snap.svg 0.2.0, Query 2.1.4
    Author: Takuma Innami

    ***/

    // アニメーションスピードをオブジェクト管理
    var speed = {
        startTime: 1000,
        generateSnowAmount: 180,
        snowLatestRandSpeed: 2000,
        santaMoving: 4000,
        showTree: 1000,
        drawTxt: 3000,
        fillTxt: 1000,
        showSnowman: 2000,
        jump: 200
    };

    // タイマーをセット
    var snowTimer;

    // ロード後、指定秒数経ってからアニメスタート
    $(window).on('load', function () {
        setTimeout(animStart, speed.startTime);
    });

    // アニメーションのスタート・順序の管理
    function animStart () {
        // 雪を降らす
        snowTimer = setInterval(generateSnow, speed.generateSnowAmount);
        // 各アニメーションを順番に実行
        generateSanta()
            .then(generateTree)
            .then(drawTxt)
            .then(generateSnowman)
            .then(animEnd);
    }

    function animEnd () {
        // 積雪をとめる
        clearInterval(snowTimer);
    }


    /*
        各アニメーションごとの関数
    */

    // svgオブジェクト
    var s = Snap('#svg');
    // jQueryオブジェクト
    var $svg = $('#svg');
    // ステージの幅と高さを取得
    var svgW = $svg.outerWidth();
    var svgH = $svg.outerHeight();

    // 雪を降らす
    function generateSnow () {
        var randX = Math.floor(Math.random() * svgW);
        var randR = Math.floor(Math.random() * svgW / 50);
        var randF = Math.floor(1 + Math.random() * 2);
        var randSpeed = Math.floor(1000 + Math.random() * speed.snowLatestRandSpeed);
        var fBlur = s.filter(Snap.filter.blur(randF, randF + 3));
        var snow = s.circle(randX, 0, randR).attr({
            fill: '#fff',
            filter: fBlur
        });
        snow.animate({
            transform: 't0, ' + svgH,
            opacity: 0
        }, randSpeed, function() {
            this.remove();
        });
    }

    // サンタクロースをロードしてアニメーション
    function generateSanta () {
        var d = new $.Deferred;
        var santa = s.group();
        var fBlur = s.filter(Snap.filter.blur(2, 2));
        Snap.load('img/santa.svg', function(f) {
            santa.append(f);
            santa.select('#santa').attr({
                x: svgW,
                y: svgH - 200,
                opacity:0.3,
                filter: fBlur
            }).animate({
                x: -175,
                y: svgH - 400,
                transform: 'scale(0.5)'
            }, speed.santaMoving, mina.easeout, function (){
                d.resolve();
            });
        });
        return d.promise();
    }

    // ツリーをロードしてアニメーション
    function generateTree () {
        var d = new $.Deferred;
        var tree = s.group();
        Snap.load('img/tree.svg', function(f) {
            tree.append(f);
            tree.select('#tree').attr({
                x: 300,
                y: 30,
                opacity:0
            }).animate({
                opacity: 0.3
            }, speed.showTree, function (){
                d.resolve();
            });
        });
        return d.promise();
    }

    // テキストのパスアニメーション
    function drawTxt(){
        var d = new $.Deferred;

        // 1文字ずつパスを配列に格納
        var snappaths = new Array();
        snappaths[0] = s.path('M339.7,214.7c-1.8,2.8-3.7,4.9-5.8,6.2c-2.1,1.3-4.6,2-7.4,2c-3.3,0-5.9-1.3-8-4c-2-2.6-3.1-6.1-3.1-10.3c0-8.6,4.1-18.6,12.2-30c-1.6,0.7-3.2,1-4.8,1c-1.8,0-3.5-0.5-5.1-1.4l-7.2,8.8v34.6l-4.8,2.4v-45.1c0-1.6-0.4-2.3-1.1-2.3c-0.7,0-1.7,0.9-3.1,2.8c-1.4,1.8-2.1,3-2.1,3.6c0,0,0,0.2,0.1,0.6c0.6,3,0.9,5.9,0.9,8.7c0,8.6-2.3,15.8-7,21.8c-4.6,6-10.1,9-16.3,9c-5.6,0-9.6-2-12-6l4.3-3.9l0.6,0.4c1.1,4.8,4.1,7.2,9,7.2c4.6,0,8.7-2.4,12.3-7.2c3.6-4.8,5.4-10.8,5.4-18.1c0-7.2-1.7-13-5.2-17.4c-3.4-4.4-7.6-6.6-12.5-6.6c-4.5,0-8.4,1.8-11.7,5.4s-5,7.6-5,11.9c0,3.1,0.9,5.7,2.7,7.9c1.8,2.2,4,3.2,6.7,3.2c2.7,0,5-1,6.9-3c1.9-2,2.9-4.4,2.9-7.2c0-1.5-0.4-2.7-1.2-3.7c-0.8-1-1.8-1.5-2.9-1.5c-1.7,0-2.7,0.9-3,2.8l-0.8-0.2c-0.2-0.7-0.3-1.3-0.3-1.7c0-1.4,0.5-2.6,1.4-3.6c0.9-1,2.1-1.5,3.5-1.5c1.7,0,3.1,0.8,4.2,2.3c1.1,1.5,1.6,3.4,1.6,5.8c0,4-1.4,7.5-4.1,10.6c-2.8,3.1-6.1,4.6-10.1,4.6c-3.1,0-5.6-1-7.5-3.1c-1.8-2.1-2.8-4.9-2.8-8.6c0-6.3,2.3-11.9,7-16.8c4.6-4.9,9.9-7.4,15.9-7.4c3.8,0,6.9,1,9.6,3c2.6,2,4.9,5.2,6.8,9.5c2.1-2.9,3.8-4.8,4.9-5.8c1.1-1,2.3-1.5,3.3-1.5c1,0,1.8,0.5,2.4,1.4c0.7,0.9,1,2.2,1,3.9v6.3l9.2-11.8c1.6,2.6,3.7,3.9,6.4,3.9c2.3,0,4.3-1,6.1-3l0.9,0.9c-5.2,5.4-8.6,11-10.3,16.7c-1.7,5.7-2.5,11-2.5,15.8c0,3.9,0.8,7,2.5,9.4c1.7,2.4,3.9,3.6,6.6,3.6c3.1,0,6.2-2.1,9-6.2L339.7,214.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[1] = s.path('M360.9,215.7c-1.6,2.6-3.4,4.5-5.3,5.7c-1.9,1.2-4.4,1.8-7.6,1.8c-2.3,0-4.1-0.7-5.4-2c-1.3-1.4-2-3.3-2-5.7c0-0.7,0.1-1.4,0.2-2.1c-1,1.3-1.7,2.3-2.3,3l-1.4-0.9c3.6-5,6.3-8.3,8.2-9.9c1.9-1.6,3.9-2.4,5.9-2.4c1.1,0,2,0.3,2.8,1c0.7,0.7,1.1,1.5,1.1,2.5c0,3.6-3.1,7.1-9.4,10.5c0.8,2,2.6,3,5.3,3c1.3,0,2.7-0.5,4.3-1.4c1.6-0.9,3-2.3,4.3-4.1L360.9,215.7z M345,215.6c4.5-2.2,6.8-4.7,6.8-7.4c0-0.8-0.2-1.5-0.7-2c-0.5-0.5-1.1-0.8-1.8-0.8c-1.4,0-2.6,0.6-3.5,1.9c-1,1.3-1.4,2.8-1.4,4.6c0,1,0.1,1.8,0.3,2.5C344.9,215.1,345,215.5,345,215.6z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[2] = s.path('M381,215.7c-3.1,4.9-6.2,7.3-9.3,7.3c-3.2,0-4.8-1.8-4.8-5.5c0-3,1.4-6.2,4.2-9.7c-0.5,0.1-1.4,0.2-2.6,0.2c-0.8,0-1.7-0.2-2.6-0.5c-1.4,3-3.2,6-5.5,8.9l-1.3-1c2.6-3.7,4.8-8,6.7-12.7c2.6,1.2,4.7,1.8,6.2,1.8c1.4,0,2.7-0.6,3.7-1.7l0.7,0.5c-1.7,2.1-3,4.2-4.1,6.3c-1,2.1-1.5,4.5-1.5,7c0,0.8,0.3,1.5,0.8,2.2s1.1,1,1.7,1c1,0,2.1-0.4,3-1.3c1-0.8,2.1-2.2,3.4-4L381,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[3] = s.path('M401.2,215.7c-3.1,4.9-6.2,7.3-9.3,7.3c-3.2,0-4.8-1.8-4.8-5.5c0-3,1.4-6.2,4.2-9.7c-0.5,0.1-1.4,0.2-2.6,0.2c-0.8,0-1.7-0.2-2.6-0.5c-1.4,3-3.2,6-5.5,8.9l-1.3-1c2.6-3.7,4.8-8,6.7-12.7c2.6,1.2,4.7,1.8,6.2,1.8c1.4,0,2.7-0.6,3.7-1.7l0.7,0.5c-1.7,2.1-3,4.2-4.1,6.3c-1,2.1-1.5,4.5-1.5,7c0,0.8,0.3,1.5,0.8,2.2s1.1,1,1.7,1c1,0,2.1-0.4,3-1.3c1-0.8,2.1-2.2,3.4-4L401.2,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[4] = s.path('M430.8,214.9c-2.9,4.8-5.7,7.4-8.3,7.8v13.1c0,3.2-1,5.9-3,8.1c-2,2.2-4.5,3.3-7.5,3.3c-1.7,0-3.4-0.4-5.1-1.3c-1.7-0.9-3-2.1-3.9-3.7l3.5-3.9l0.6,0.5c-0.1,0.7-0.2,1.2-0.2,1.6c0,1.3,0.6,2.4,1.7,3.5s2.5,1.5,4,1.5c1.7,0,3.1-0.7,4-2c1-1.3,1.5-3.2,1.5-5.6v-23c-2.2,3.2-4,5.3-5.3,6.5s-2.6,1.7-3.9,1.7c-2.6,0-3.9-1.4-3.9-4.3v-9.7c-1,2.4-2.4,4.7-4,7l-1.2-1.1c2.7-4.1,4.4-7.6,5.2-10.4l4.4-2.2v16.2c0,1,0.4,1.4,1.2,1.4h0.4c1,0,3.4-2.9,7.2-8.6v-6.9l4.4-2.2v17.8c1.9-0.2,4.2-2.3,7-6.4L430.8,214.9z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[5] = s.path('M491.5,214.7c-2,3.1-4.4,5.4-7,6.7c-2.6,1.4-6,2-10.1,2c-6.6,0-11.9-2-15.9-6.1c-4-4.1-6-9.4-6-16c0-5.6,1.4-11,4.3-16.3c2.8-5.3,6.6-9.5,11.2-12.7c4.6-3.2,9.3-4.8,13.9-4.8c3.4,0,6.1,0.9,8.1,2.8c2,1.9,3,4.5,3,7.8c0,4.8-1.7,9.1-5.2,13c-3.5,3.8-7.2,5.7-11.3,5.7c-2.1,0-3.7-0.6-5-1.9c-1.3-1.3-2-2.9-2-4.9c0-3.2,1.8-6.3,5.5-9.1l0.9,1c-2,1.3-3,3.3-3,6.1c0,1.7,0.6,3.1,1.7,4.2c1.2,1.1,2.6,1.6,4.4,1.6c2.8,0,5.2-1.2,7.4-3.6c2.2-2.4,3.2-5.3,3.2-8.7c0-3.3-1-5.9-3-7.9c-2-2-4.7-3-8-3c-5.5,0-10.4,2.6-14.7,7.8c-4.3,5.2-6.4,11.4-6.4,18.7c0,6.7,1.9,12.3,5.7,16.7c3.8,4.5,8.6,6.7,14.5,6.7c2.9,0,5.3-0.5,7.3-1.5c1.9-1,3.7-2.8,5.3-5.2L491.5,214.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[6] = s.path('M520.6,215.7c-3.3,4.9-6.6,7.3-9.7,7.3c-0.9,0-1.6-0.3-2.1-1c-0.5-0.7-0.7-2.1-0.7-4.4v-9c0-1.6-0.6-2.3-1.8-2.3c-1,0-2,0.5-3.1,1.4s-2.1,2.2-2.9,3.9s-1.3,2.7-1.3,3.2v6.3l-4.2,2.6v-14.5c-1.4,2.8-2.9,5.2-4.5,7.2l-1.3-1c0.7-1,1.3-2,1.9-2.9c0.6-0.9,1.4-2.4,2.4-4.4c1-2,1.5-3.2,1.5-3.6v-17.8c0-3.9,1-7.1,2.9-9.6c1.9-2.5,4.2-3.7,6.7-3.7c3.1,0,4.6,1.9,4.6,5.6c0,4.9-3.4,12.7-10.1,23.4v7.7c2-2.6,3.7-4.4,5.1-5.4c1.4-1,2.9-1.5,4.4-1.5c2.5,0,3.8,1.8,3.8,5.4v8.3c0,2.1,0.4,3.1,1.2,3.1c1.4,0,3.4-1.8,6-5.4L520.6,215.7z M498.9,199c2.7-4.9,4.6-8.8,5.6-11.6s1.6-5.5,1.6-7.8c0-1.4-0.3-2.5-0.8-3.4c-0.5-0.9-1.3-1.3-2.1-1.3c-1.3,0-2.3,0.9-3.1,2.6c-0.8,1.7-1.1,4-1.1,7V199z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[7] = s.path('M540.7,215.7c-3.1,4.9-6.2,7.3-9.3,7.3c-3.2,0-4.8-1.8-4.8-5.5c0-3,1.4-6.2,4.2-9.7c-0.5,0.1-1.4,0.2-2.6,0.2c-0.8,0-1.7-0.2-2.6-0.5c-1.4,3-3.2,6-5.5,8.9l-1.3-1c2.6-3.7,4.8-8,6.7-12.7c2.6,1.2,4.7,1.8,6.2,1.8c1.4,0,2.7-0.6,3.7-1.7l0.7,0.5c-1.7,2.1-3,4.2-4.1,6.3s-1.5,4.5-1.5,7c0,0.8,0.3,1.5,0.8,2.2c0.5,0.7,1.1,1,1.7,1c1,0,2-0.4,3-1.3c1-0.8,2.1-2.2,3.4-4L540.7,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[8] = s.path('M556.6,215.7c-1.6,2.4-3.2,4.2-4.8,5.4s-3.1,1.9-4.4,1.9c-1.5,0-2.4-0.4-2.8-1.2c-0.4-0.8-0.6-2.2-0.6-4.2v-7.5c-0.8,2.2-2.1,4.3-3.7,6.3l-1.3-1c2.5-3.5,4.2-7,5-10.3l4.1-2.2v13c0,1.6,0.1,2.7,0.2,3.2s0.5,0.8,1.1,0.8c1.2,0,3.2-1.8,6-5.4L556.6,215.7z M549.5,195l-2.9,3.7l-2.9-3.7l2.9-3.5L549.5,195z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[9] = s.path('M564.5,202.3c2.1,1.1,3.8,2.7,5.1,4.8s1.9,4.2,1.9,6.4c0,2.5-0.7,4.8-2.2,6.7c-1.5,1.9-3.4,2.8-5.7,2.8c-1.2,0-2.4-0.4-3.7-1.2c-1.3-0.8-2.5-1.9-3.5-3.4c0.8-1.3,2.1-2.4,3.7-3.4l0.3,0.4c-0.1,0.3-0.1,0.7-0.1,1.2c0,1.2,0.4,2.2,1.2,3.1c0.8,0.9,1.7,1.4,2.8,1.4c1.3,0,2.3-0.5,3.1-1.6c0.8-1.1,1.2-2.4,1.2-4.1c0-3.4-2-6.4-6-9.1l-3.5,5.5c-1.4,2.2-2.4,3.8-3,4.5l-1.3-1c2.8-4.1,5.6-9.2,8.3-15.1l1,0.1L564.5,202.3z M578.5,215.7c-2.9,4.8-6.6,7.4-11.1,7.8l-0.2-0.8c2-0.5,3.6-1.2,5-2.3c1.4-1.1,3.1-3,5.1-5.7L578.5,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[10] = s.path('M596.8,215.6c-3.1,5-6.4,7.4-9.8,7.4c-1.6,0-2.7-0.4-3.1-1.2s-0.6-2-0.6-3.7v-9.9c-1.8,3.1-3.6,5.8-5.4,8.1l-1.4-1c1-1.5,1.9-2.8,2.6-3.9s1.6-2.6,2.6-4.4c1-1.8,1.5-2.8,1.5-3.1v-16.8l4.1-4v15.6l6.3-9.9l1.6,1.2l-7.9,12.5v12.6c0,1.9,0.1,3.2,0.2,3.9c0.2,0.6,0.6,1,1.4,1c1.9,0,4.1-1.8,6.7-5.5L596.8,215.6z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[11] = s.path('M637.3,215.7c-3.2,4.9-6.4,7.3-9.7,7.3c-0.9,0-1.7-0.3-2.2-0.9s-0.8-2.1-0.8-4.5V208c0-1-0.4-1.5-1.2-1.5c-0.5,0-1,0.2-1.5,0.6c-0.5,0.4-1.1,0.9-1.7,1.7c-0.6,0.7-1.4,2-2.4,3.6s-1.5,2.7-1.5,2.9v6.5l-4.1,2v-15c0-1.2-0.4-1.8-1.3-1.8c-0.7,0-1.5,0.4-2.3,1.2s-1.8,2.1-2.9,4c-1.1,1.9-1.6,3-1.6,3.2v6.5l-4.1,2v-13.6c-0.8,2.2-2.1,4.3-3.7,6.3l-1.3-1c2.4-3.3,4.1-6.8,5-10.5l4.1-1.9v8.5c3.1-5.3,6.1-8,8.8-8c1.2,0,2,0.5,2.6,1.4c0.6,0.9,0.9,3.1,0.9,6.7c1.7-3,3.3-5.1,4.6-6.2c1.3-1.2,2.7-1.8,4.2-1.8c2.4,0,3.5,1.6,3.5,4.8v7.6c0,1.9,0.1,3.1,0.3,3.5c0.2,0.4,0.5,0.6,1,0.6c1.2,0,3.2-1.8,6-5.4L637.3,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[12] = s.path('M666.2,215.7c-3.1,4.9-6.2,7.3-9.2,7.3c-1.1,0-1.9-0.3-2.4-0.9c-0.5-0.6-0.8-1.9-0.8-3.8c-1.6,2-3,3.3-4.2,4s-2.4,0.9-3.9,0.9c-2.1,0-3.8-0.7-5-2.2s-1.9-3.4-1.9-5.8v-1.8c-0.3,0.4-1,1.4-2.1,3l-1.4-0.9c2.4-3.7,5-6.6,7.6-8.8c2.7-2.1,5-3.2,7-3.2c1.4,0,2.8,0.4,4.2,1.3l3.6-1.8v14c0,1.5,0.1,2.4,0.2,2.7c0.1,0.3,0.5,0.5,1.1,0.5c0.5,0,1.3-0.5,2.3-1.4c1-0.9,2.2-2.3,3.4-4L666.2,215.7z M653.8,215.2v-8.3c-1.1-1.1-2.4-1.7-4-1.7c-1.7,0-3.1,0.8-4.5,2.3c-1.3,1.5-2,3.4-2,5.7c0,2,0.5,3.5,1.4,4.6c0.9,1.1,2.2,1.6,3.8,1.6c1.3,0,2.4-0.6,3.5-1.9C653.2,216.3,653.8,215.5,653.8,215.2z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});
        snappaths[13] = s.path('M674,202.3c2.1,1.1,3.8,2.7,5.1,4.8s1.9,4.2,1.9,6.4c0,2.5-0.7,4.8-2.2,6.7c-1.5,1.9-3.4,2.8-5.7,2.8c-1.2,0-2.4-0.4-3.7-1.2c-1.3-0.8-2.5-1.9-3.5-3.4c0.8-1.3,2.1-2.4,3.7-3.4l0.3,0.4c-0.1,0.3-0.1,0.7-0.1,1.2c0,1.2,0.4,2.2,1.2,3.1c0.8,0.9,1.7,1.4,2.8,1.4c1.3,0,2.3-0.5,3.1-1.6c0.8-1.1,1.2-2.4,1.2-4.1c0-3.4-2-6.4-6-9.1l-3.5,5.5c-1.4,2.2-2.4,3.8-3,4.5l-1.3-1c2.8-4.1,5.6-9.2,8.3-15.1l1,0.1L674,202.3z M688.1,215.7c-2.9,4.8-6.6,7.4-11.1,7.8l-0.2-0.8c2-0.5,3.6-1.2,5-2.3c1.4-1.1,3.1-3,5.1-5.7L688.1,215.7z').attr({'stroke-width': 1, fill: 'none', stroke:'none'});

        var i;
        for (i = 0; i < snappaths.length; i++) {
            var len = Math.ceil(snappaths[i].getTotalLength());
            snappaths[i].attr({
                'stroke-width': 1,
                fill:'none',
                stroke:'#fff',
                strokeDasharray:len,
                strokeDashoffset:len
            });
            snappaths[i].animate({
                strokeDashoffset: 0
            }, speed.drawTxt, function (){
                this.animate({
                    fill:'#fff',
                    opacity: 1
                }, speed.fillTxt, function (){
                    d.resolve();
                });
            });
        }
        return d.promise();
    }

    // 雪だるまをロードしてアニメーション
    function generateSnowman () {
        var d = new $.Deferred;
        var snowman = s.group();
        Snap.load('img/snowman1.svg', function(f) {
            snowman.append(f);
            snowman.select('#snowman1').attr({
                x: svgW - 200,
                y: svgH - 200,
                opacity: 0
            }).animate({
                opacity:0.8
            }, speed.showSnowman, function (){
                d.resolve();
                jump(this);
            });
        });
        Snap.load('img/snowman2.svg', function(f) {
            snowman.append(f);
            snowman.select('#snowman2').attr({
                x: 0,
                y: svgH - 200,
                opacity: 0
            }).animate({
                opacity:0.8
            }, speed.showSnowman, function (){
                d.resolve();
                jump(this);
            });
        });
        return d.promise();
    }

    // 雪だるまをジャンプさせるアニメーション
    function jump (obj) {
        obj.animate({
            y: svgH - 220,
        }, speed.jump / 2, function (){
            obj.animate({
                y: svgH - 200,
            }, speed.jump / 2);
        });
    }

});


/* 作成メモ

■こだわりポイント
・snap.svgを使用してsvgにメーションしてみました。
・Deferredオブジェクトを使ってコールバック地獄を回避してみました。

■苦労したところ
・読み込んだ外部svgへの操作

■疑問
・svgには重ね順を指定する方法はないのか

■感想
svgアニメーションがやはり重いです。
opacity操作やblurが原因かも。軽くしたいけどアプローチがわからないです。。

*/